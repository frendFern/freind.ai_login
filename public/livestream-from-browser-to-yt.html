<!DOCTYPE html>
<!--
    Server.js from https://github.com/piavgh/live-stream-socket-server MUST be running in order for this to stream the browser to youtube.
-->
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Stream</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
        <script src="https://apis.google.com/js/api.js"></script>
        <script src="https://apis.google.com/js/platform.js"></script>

        <link rel="stylesheet" type="text/css" href="/styles/styles.css">
    </head>

    <body>
        <div id="app">
            <h1>Multistream</h1>
            <input id="streamTitle" placeholder="Type in your stream title" type="text"></input>
            <input id="streamDescription"  placeholder="Type in your stream description" type="text"></input>
            <input class="livestreamButton" type="button" value="Start Streaming in 720p" onclick="createBroadcastStream()"></input>
            <input class="livestreamButton" type="button" value="Stop Streaming" onclick="stopStreaming()"></input>

            <div class="outputCanvas"><canvas id="canvasElement"></canvas></div>
            <video hidden autoplay id="livestreamVideo"></video> 
            <video hidden id="cameraVideo"></video>
    </div>

    </body>
    <script>
            const CAMERA_CONSTRAINTS = { audio: true, video: true };

            let connected = false;
            let title;
            let description;
            let textOverlay = 'Live from the browser!';
            let inputStream;
            let streamKey;
            let cameraVideo = document.getElementById("cameraVideo")
            let canvasElement= document.getElementById("canvasElement")
            let wsConnection;
            let mediaRecorder;
            let broadcastId;
            let streamId;
            var LiveStreaming = false
            var settings = {
                compression: 40
            }
            const livestreamVideo = document.getElementById('livestreamVideo');
            let accessToken;

            async function bindBroadcastToStream (){
                const config = {
                    headers: {
                        Authorization: `Bearer ${accessToken}`,
                        Accept: 'application/json',
                    },
                }
                const bindedBroadcast = await axios.post(
                    `https://youtube.googleapis.com/youtube/v3/liveBroadcasts/bind?id=${broadcastId}&part=snippet&streamId=${streamId}&access_token=${accessToken}`,
                    config
                ).then(res => {
                    return res
                }).catch(err => {
                    console.log("Error in binding broadcast to stream: " + err)
                });
                enableMic()
            } 
            async function makeStreamlive(){
                const data = {
                    snippet: {
                        title: title,
                        description: description,
                    },
                        cdn: {
                        format: '',
                        ingestionType: 'rtmp',
                        frameRate: 'variable',
                        resolution: 'variable',
                    },
                    contentDetails: { isReusable: true },
                }

                const config = {
                    headers: {
                        Authorization: `Bearer ${accessToken}`,
                        Accept: 'application/json',
                        'Content-Type': 'application/json',
                    },
                }
                const stream = await axios
                    .post(
                        `https://youtube.googleapis.com/youtube/v3/liveStreams?part=snippet%2Ccdn%2CcontentDetails%2Cstatus`,
                        data,
                        config
                    )
                    .then((res) => {
                        const { ingestionAddress, streamName } = res.data.cdn.ingestionInfo
                        return {
                            id: res.data.id,
                            youtubeDestinationUrl: ingestionAddress + '/' + streamName,
                            streamKey: streamName
                        }
                    })
                    .catch((error) => {
                        console.log("error in making stream id " + error)
                    })
                streamKey = stream.streamKey
                streamId = stream.id;
                bindBroadcastToStream()
            }

            async function createBroadcastStream() {
                title = (document.getElementById("streamTitle")).value.trim()
                description = (document.getElementById("streamDescription")).value.trim()
                if (title == "" || description == ""){
                    alert("Please enter stream title and stream description")
                    return;
                }

                // Get access token
                const currentUrl = new URL(window.location.href);
                const params = new URLSearchParams(currentUrl.hash.slice(1));
                accessToken = params.get('access_token');
                if (!accessToken){
                    alert("No access token. Please go to /authorize-yt-browser-streaming.html to authorize your google account.")
                    return;
                }

                const data = {
                    snippet: {
                        title: title,
                        scheduledStartTime: `${new Date().toISOString()}`,
                        description: description,
                    },
                    contentDetails: {
                        recordFromStart: true,
                        enableAutoStart: true,
                        monitorStream: { enableMonitorStream: false },
                    },
                    status: {
                        privacyStatus: 'unlisted'
                    },
                }
                const config = {
                    headers: {
                    Authorization: `Bearer ${accessToken}`,
                    Accept: 'application/json',
                    'Content-Type': 'application/json',
                    },
                }
                const broadcast = await axios
                    .post(
                        `https://youtube.googleapis.com/youtube/v3/liveBroadcasts?part=snippet%2CcontentDetails%2Cstatus%2Cid&access_token=${accessToken}`,
                        data,
                        config
                    )
                    .then((res) => {
                        return res.data.id
                    })
                    .catch((err) => console.log(err))
                broadcastId = broadcast;
                await makeStreamlive()
            }

            async function enableMic() {
                await navigator.mediaDevices.getUserMedia(CAMERA_CONSTRAINTS).then(stream => {
                    inputStream = stream;
                    cameraVideo.srcObject = inputStream;
                    cameraVideo.play().catch(console.error);

                    canvasElement.height = cameraVideo.clientHeight;
                    canvasElement.width = cameraVideo.clientWidth;

                    requestAnimationId = requestAnimationFrame(cameraUpdateCanvas);
                    cameraEnabled = true;
                }).catch(console.error);

                streamCanvasToYoutube()
            }

            function cameraUpdateCanvas() {
                if (cameraVideo.ended || cameraVideo.paused) {
                    return;
                }
                const ctx = canvasElement.getContext('2d');
                ctx.drawImage(cameraVideo, 0, 0, cameraVideo.clientWidth, cameraVideo.clientHeight);
                ctx.fillStyle = '#FB3C4E';
                ctx.font = '50px Akkurat';
                ctx.fillText("AAAAAA", 10, 50, canvasElement.width - 20);

                requestAnimationId = requestAnimationFrame(cameraUpdateCanvas);
            }

            function hasAudioTrack(stream) {
                let tracks = stream.getTracks();
                for (const track of tracks) {
                    if (track.kind === 'audio') {
                        return true
                    }
                }
                return false
            }

            async function streamCanvasToYoutube() {
                if (LiveStreaming){
                    alert("Please stop your current stream first.")
                    return;
                }
                if (streamKey == ""){
                    alert('Something went wrong, no stream key was created. Please try again.')
                    return;
                }
                settings.w = 1280;
                settings.h = 720;

                await navigator.mediaDevices.getDisplayMedia({
                    video: { 
                        displaySurface: "monitor",
                        width: settings.w,
                        height: settings.h
                    },
                    audio: {
                        suppressLocalAudioPlayback: false,
                    },
                    systemAudio: "include"
                }).then(async stream => {

                    // Override microphone audio track with stream audio track if exists. 
                    // WARNING: If we set audio track to stream audio track and there is no audio from stream.. it will cause stream to NOT WORK
                    if (hasAudioTrack(stream)){
                        inputStream = stream;
                    }

                    window.stream = stream;
                    livestreamVideo.srcObject = stream;

                    let context = canvasElement.getContext('2d');
                    canvasElement.width = settings.w;
                    canvasElement.height = settings.h;
                    
                    function updateCanvas() {
                        context.drawImage(livestreamVideo, 0, 0, canvasElement.width, canvasElement.height);
                        window.requestAnimationFrame(updateCanvas);
                    }
                    window.requestAnimationFrame(updateCanvas);
                    await startStreaming()
                }).catch(err => {
                    console.log("Error: " + err)
                });
            }

            function stopStreaming() {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
                LiveStreaming = false;
            }

            async function startStreaming() {
                LiveStreaming = true

                const wsUrl = `ws://localhost:8080/rtmp?key=${streamKey}`;
                wsConnection = new WebSocket(wsUrl);

                wsConnection.addEventListener('open', function open() {
                    connected = true;
                });

                wsConnection.addEventListener('close', (e) => {
                    connected = false;
                    stopStreaming();
                    alert("Stream closed. Either the stream was manually closed or invalid stream key.")
                    console.log(e)
                });

                const videoOutputStream = canvasElement.captureStream(30);
                const audioStream = new MediaStream(inputStream.getAudioTracks());
                const outputStream = new MediaStream([...audioStream.getTracks(),...videoOutputStream.getTracks()]);
                mediaRecorder = new MediaRecorder(outputStream, {
                    mimeType: 'video/webm',
                    videoBitsPerSecond: 3000000,
                });

                mediaRecorder.addEventListener('dataavailable', (e) => {
                    wsConnection.send(e.data);
                });

                mediaRecorder.addEventListener('stop', () => {
                    stopStreaming();
                    wsConnection.close();
                });

                mediaRecorder.start(1000);
            }

    </script>
</html>
